<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">
<body>
<div layout:fragment="content">

    <!-- ALERTS -->
    <div class="col-md-12">
        <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${success}">
            <span th:text="${success}">Message de succès</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${error}">
            <span th:text="${error}">Message d'erreur</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <div class="card mt-3">
        <!-- TABS -->
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li th:each="compEntry, iterStat : ${page.components.entrySet()}" class="nav-item">
                    <a th:href="'#tabs-' + ${iterStat.index}"
                       class="nav-link text-capitalize"
                       data-bs-toggle="tab"
                       th:classappend="${iterStat.index == 0} ? ' active'">
                        <span th:text="${compEntry.value['type'] != null ? compEntry.value['type'] + ' (' + compEntry.key + ')' : compEntry.key}">
                            default
                        </span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- TAB CONTENT -->
        <div class="card-body">
            <div class="tab-content">
                <div th:each="compEntry, iterStat : ${page.components.entrySet()}"
                     th:id="'tabs-' + ${iterStat.index}"
                     class="tab-pane fade"
                     th:classappend="${iterStat.index == 0} ? ' show active'">

                    <form th:action="@{'/admin/pages/save/' + ${pageName}}" method="post">

                        <input type="hidden" th:name="'component_key'" th:value="${compEntry.key}"/>

                        <!-- HERO -->
                        <div th:if="${compEntry.value['type'] == 'hero'}">
                            <h4>Configuration Hero</h4>

                            <div class="mb-3">
                                <label>Status</label>
                                <select class="form-select" th:name="'components[' + ${compEntry.key} + '][status]'">
                                    <option value="enable" th:selected="${compEntry.value['status'] == 'enable'}">Activé</option>
                                    <option value="disable" th:selected="${compEntry.value['status'] == 'disable'}">Désactivé</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label>Titre</label>
                                    <input type="text" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][title]'"
                                           th:value="${compEntry.value['title'] ?: ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>Sous-titre</label>
                                    <input type="text" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][subtitle]'"
                                           th:value="${compEntry.value['subtitle'] ?: ''}">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label>Description</label>
                                <textarea class="form-control" rows="4"
                                          th:name="'components[' + ${compEntry.key} + '][description]'"
                                          th:text="${compEntry.value['description'] ?: ''}"></textarea>
                            </div>

                            <!-- hidden false + checkbox true to ensure false is posted when unchecked -->
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input"
                                       th:name="'components[' + ${compEntry.key} + '][button]'"
                                       value="true"
                                       th:checked="${compEntry.value['button'] == true}"/>
                                <input type="hidden" th:name="'components[' + ${compEntry.key} + '][button]'" value="false"/>
                                <label class="form-check-label">Activer les boutons</label>
                            </div>

                            <!-- BOUTONS: on évite #lists/... => on traite explicitement 'one' et 'two' -->
                            <div th:if="${compEntry.value['buttons'] != null}" class="">
                                <h5>Boutons</h5>
                                <div class="row">
                                    <!-- Bouton ONE -->
                                    <div class="col">
                                        <div class="card mb-3" th:with="b=${compEntry.value['buttons']['one']}">
                                            <div class="card-header">Bouton 1</div>
                                            <div class="card-body">
                                                <label>Texte</label>
                                                <input type="text" class="form-control"
                                                       th:name="'components[' + ${compEntry.key} + '][buttons][one][text]'"
                                                       th:value="${b != null ? b['text'] : ''}"/>
                                                <label>Style</label>
                                                <select class="form-select"
                                                        th:name="'components[' + ${compEntry.key} + '][buttons][one][style]'">
                                                    <option value="1" th:selected="${b != null ? b['style'] == 1 : false}">Style 1</option>
                                                    <option value="2" th:selected="${b != null ? b['style'] == 2 : false}">Style 2</option>
                                                </select>
                                                <label>URL</label>
                                                <input type="text" class="form-control"
                                                       th:name="'components[' + ${compEntry.key} + '][buttons][one][url]'"
                                                       th:value="${b != null ? b['url'] : ''}"/>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bouton TWO -->
                                    <div class="col">
                                        <div class="card mb-3" th:with="b=${compEntry.value['buttons']['two']}">
                                            <div class="card-header">Bouton 2</div>
                                            <div class="card-body">
                                                <label>Texte</label>
                                                <input type="text" class="form-control"
                                                       th:name="'components[' + ${compEntry.key} + '][buttons][two][text]'"
                                                       th:value="${b != null ? b['text'] : ''}"/>
                                                <label>Style</label>
                                                <select class="form-select"
                                                        th:name="'components[' + ${compEntry.key} + '][buttons][two][style]'">
                                                    <option value="1" th:selected="${b != null ? b['style'] == 1 : false}">Style 1</option>
                                                    <option value="2" th:selected="${b != null ? b['style'] == 2 : false}">Style 2</option>
                                                </select>
                                                <label>URL</label>
                                                <input type="text" class="form-control"
                                                       th:name="'components[' + ${compEntry.key} + '][buttons][two][url]'"
                                                       th:value="${b != null ? b['url'] : ''}"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VIDEO -->
                        <div th:if="${compEntry.value['type'] == 'video'}">
                            <h4>Configuration Vidéo</h4>

                            <div class="mb-3">
                                <label>Status</label>
                                <select class="form-select" th:name="'components[' + ${compEntry.key} + '][status]'">
                                    <option value="enable" th:selected="${compEntry.value['status'] == 'enable'}">Activé</option>
                                    <option value="disable" th:selected="${compEntry.value['status'] == 'disable'}">Désactivé</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label>Titre</label>
                                    <input type="text" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][title]'"
                                           th:value="${compEntry.value['title'] ?: ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>Sous-titre</label>
                                    <input type="text" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][subtitle]'"
                                           th:value="${compEntry.value['subtitle'] ?: ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>URL Vidéo</label>
                                    <input type="url" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][video_url]'"
                                           th:value="${compEntry.value['video_url'] ?: ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>Image de couverture</label>
                                    <input type="url" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][video_poster]'"
                                           th:value="${compEntry.value['video_poster'] ?: ''}">
                                </div>
                            </div>
                        </div>

                        <!-- ROW CARDS -->
                        <div th:if="${compEntry.value['type'] == 'row_cards_1' or compEntry.value['type'] == 'row_cards_2'}">
                            <h4>Configuration Cards</h4>

                            <div class="mb-3">
                                <label>Status</label>
                                <select class="form-select" th:name="'components[' + ${compEntry.key} + '][status]'">
                                    <option value="enable" th:selected="${compEntry.value['status'] == 'enable'}">Activé</option>
                                    <option value="disable" th:selected="${compEntry.value['status'] == 'disable'}">Désactivé</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label>Titre</label>
                                    <input type="text" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][title]'"
                                           th:value="${compEntry.value['title'] ?: ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>Sous-titre</label>
                                    <input type="text" class="form-control"
                                           th:name="'components[' + ${compEntry.key} + '][subtitle]'"
                                           th:value="${compEntry.value['subtitle'] ?: ''}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4" th:if="${compEntry.value['cards'] != null}" th:each="cardEntry : ${compEntry.value['cards'].entrySet()}">
                                    <div class="card">
                                        <div class="card-header" th:text="'Carte: ' + ${cardEntry.key}">Carte</div>
                                        <div class="card-body" th:with="c=${cardEntry.value}">
                                            <label>Icône</label>
                                            <input type="text" class="form-control"
                                                   th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][icon]'"
                                                   th:value="${c != null ? c['icon'] : ''}"/>
                                            <label>Titre</label>
                                            <input type="text" class="form-control"
                                                   th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][title]'"
                                                   th:value="${c != null ? c['title'] : ''}"/>
                                            <label>Description</label>
                                            <textarea class="form-control" rows="3"
                                                      th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][description]'"
                                                      th:text="${c != null ? c['description'] : ''}"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CARD_MODAL (ex: Projects) -->
                        <div th:if="${compEntry.value['type'] == 'card_modal' or compEntry.value['type'] == 'projects' }">
                            <h4>Configuration Card Modal</h4>

                            <div class="mb-3">
                                <label>Status</label>
                                <select class="form-select" th:name="'components[' + ${compEntry.key} + '][status]'">
                                    <option value="enable" th:selected="${compEntry.value['status'] == 'enable'}">Activé</option>
                                    <option value="disable" th:selected="${compEntry.value['status'] == 'disable'}">Désactivé</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label>Titre de section</label>
                                <input type="text" class="form-control"
                                       th:name="'components[' + ${compEntry.key} + '][title]'"
                                       th:value="${compEntry.value['title'] ?: ''}">
                            </div>

                            <div class="mb-3">
                                <label>Sous-titre</label>
                                <input type="text" class="form-control"
                                       th:name="'components[' + ${compEntry.key} + '][subtitle]'"
                                       th:value="${compEntry.value['subtitle'] ?: ''}">
                            </div>

                            <hr/>

                            <h5>Cards (modals)</h5>
                            <div th:if="${compEntry.value['cards'] != null}" th:each="cardEntry : ${compEntry.value['cards'].entrySet()}"
                                 th:with="c=${cardEntry.value}, modal=${c['modal']}, video=${modal != null ? modal['video'] : null}">
                                <div class="border p-3 mb-3 rounded">
                                    <h6 th:text="'Carte ' + ${cardEntry.key}">Carte</h6>

                                    <div class="mb-3">
                                        <label>Poster (image)</label>
                                        <input type="text" class="form-control"
                                               th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][poster]'"
                                               th:value="${c['poster'] ?: ''}"/>
                                    </div>

                                    <div class="mb-3">
                                        <label>Titre</label>
                                        <input type="text" class="form-control"
                                               th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][title]'"
                                               th:value="${c['title'] ?: ''}"/>
                                    </div>

                                    <div class="mb-3">
                                        <label>Type de vidéo</label>
                                        <select class="form-select"
                                                th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][modal][video][type]'">
                                            <option value="youtube" th:selected="${video != null ? video['type'] == 'youtube' : false}">YouTube</option>
                                            <option value="local" th:selected="${video != null ? video['type'] == 'local' : false}">Local</option>
                                            <option value="vimeo" th:selected="${video != null ? video['type'] == 'vimeo' : false}">Vimeo</option>
                                            <option value="file" th:selected="${video != null ? video['type'] == 'file' : false}">File</option>
                                            <option value="none" th:selected="${video != null ? video['type'] == 'none' : false}">Aucune</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label>URL de la vidéo</label>
                                        <input type="text" class="form-control"
                                               th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][modal][video][url]'"
                                               th:value="${video != null ? video['url'] : ''}"/>
                                    </div>

                                    <div class="mb-3">
                                        <label>Description</label>
                                        <textarea class="form-control" rows="3"
                                                  th:name="'components[' + ${compEntry.key} + '][cards][' + ${cardEntry.key} + '][modal][description]'"
                                                  th:text="${modal != null ? modal['description'] : ''}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- BOUTON DE SAUVEGARDE -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                💾 Sauvegarder ce composant
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</body>
</html>
